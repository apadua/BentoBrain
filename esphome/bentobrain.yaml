# BentoBrain ESPHome Configuration
# Smart fan controller for 3D printers using Home Assistant integration

esphome:
  name: bentobrain-v2
  friendly_name: BentoBrain v2

esp32:
  board: esp32-c3-devkitm-1
  framework:
    type: arduino

# WiFi Configuration
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password


# Enable logging
logger:
  level: INFO

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key

# Enable Over-The-Air updates
ota:
  - platform: esphome
    password: !secret ota_password

# PWM Output for Fan Control
output:
  - platform: ledc
    pin: GPIO5
    id: fan_pwm_output
    frequency: 25000 Hz  # 25 kHz PWM frequency (matches Arduino config)
    channel: 0

# Fan Entity - Controllable from Home Assistant with percentage speed
fan:
  - platform: speed
    output: fan_pwm_output
    name: "BentoBrain Fan"
    id: bentobrain_fan
    restore_mode: RESTORE_DEFAULT_OFF

# Fan RPM Monitoring (TACH pin)
sensor:
  # Pulse counter for TACH signal
  - platform: pulse_counter
    pin:
      number: GPIO6
      mode:
        input: true
        pullup: true
    name: "Fan Pulses"
    id: fan_pulses
    internal: true  # Hide raw pulse count
    unit_of_measurement: "pulses/min"
    update_interval: 5s
    count_mode:
      rising_edge: INCREMENT
      falling_edge: DISABLE
    filters:
      - multiply: 0.5  # Most fans output 2 pulses per revolution
    accuracy_decimals: 0

  # Convert pulses to RPM
  - platform: template
    name: "Fan RPM"
    id: fan_rpm
    unit_of_measurement: "RPM"
    icon: "mdi:fan"
    accuracy_decimals: 0
    lambda: |-
      return id(fan_pulses).state;
    update_interval: 5s

# Binary sensor to detect fan failure
binary_sensor:
  - platform: template
    name: "Fan Running"
    id: fan_running
    icon: "mdi:fan-alert"
    lambda: |-
      // Consider fan running if RPM > 100
      return id(fan_rpm).state > 100;
    filters:
      - delayed_off: 10s  # Avoid false alarms during spin-up/down
